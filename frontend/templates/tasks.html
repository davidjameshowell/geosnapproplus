{% extends "base.html" %}

{% block title %}All Tasks{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">All Tasks</h1>
            <p class="text-gray-600">Manage your screenshots and recordings</p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="/submit" class="inline-flex items-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Create New Task
            </a>
        </div>
    </div>

    {% if tasks %}
    <!-- Filters and Search -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <!-- Search -->
            <div class="flex-1">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search by URL..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>

            <!-- Type Filter -->
            <div>
                <select id="typeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="all">All Types</option>
                    <option value="screenshot">üì∏ Screenshots</option>
                    <option value="recording">üé• Recordings</option>
                </select>
            </div>

            <!-- Status Filter -->
            <div>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="all">All Statuses</option>
                    <option value="completed">‚úì Completed</option>
                    <option value="running">‚ü≥ Running</option>
                    <option value="pending">‚è≥ Pending</option>
                    <option value="failed">‚úó Failed</option>
                </select>
            </div>

            <!-- Sort -->
            <div>
                <select id="sortOrder" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="status">By Status</option>
                </select>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="mt-3 hidden">
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600">Active filters:</span>
                <div id="filterTags" class="flex flex-wrap gap-2"></div>
                <button id="clearFilters" class="text-sm text-blue-600 hover:text-blue-700 font-medium ml-2">
                    Clear all
                </button>
            </div>
        </div>
    </div>

    <!-- Task Count -->
    <div class="mb-4 flex items-center justify-between">
        <p class="text-sm text-gray-600">
            Showing <span id="visibleCount" class="font-semibold">{{ tasks|length }}</span> of 
            <span id="totalCount" class="font-semibold">{{ tasks|length }}</span> tasks
        </p>
        <div class="flex items-center space-x-2">
            <label class="flex items-center text-sm text-gray-600">
                <input type="checkbox" id="autoRefresh" checked class="mr-2 rounded">
                Auto-refresh
            </label>
        </div>
    </div>

    <!-- Tasks Grid -->
    <div id="tasksList" class="grid grid-cols-1 gap-4">
        {% for task in tasks %}
        <div class="task-card bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-200 hover:border-blue-300"
             data-task-id="{{ task.id }}"
             data-type="{{ task.type }}"
             data-status="{{ task.status }}"
             data-url="{{ task.url|lower }}"
             data-timestamp="{{ task.timestamp }}">
            
            <div class="flex flex-col md:flex-row">
                <!-- Left: Icon & Status -->
                <div class="flex-shrink-0 p-6 flex flex-col items-center justify-center bg-gradient-to-br {% if task.type == 'screenshot' %}from-blue-50 to-blue-100{% else %}from-purple-50 to-purple-100{% endif %}">
                    <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-md mb-2">
                        <span class="text-3xl">{% if task.type == 'screenshot' %}üì∏{% else %}üé•{% endif %}</span>
                    </div>
                    <span class="text-xs font-medium {% if task.type == 'screenshot' %}text-blue-700{% else %}text-purple-700{% endif %}">
                        {{ task.type|upper }}
                    </span>
                </div>

                <!-- Center: Task Info -->
                <div class="flex-1 p-6">
                    <!-- Status Badge -->
                    <div class="flex items-center mb-3">
                        <span class="status-badge px-3 py-1 text-xs font-semibold rounded-full inline-flex items-center
                                     {% if task.status == 'completed' %}bg-green-100 text-green-800 border border-green-200
                                     {% elif task.status == 'running' %}bg-blue-100 text-blue-800 border border-blue-200
                                     {% elif task.status == 'failed' %}bg-red-100 text-red-800 border border-red-200
                                     {% else %}bg-yellow-100 text-yellow-800 border border-yellow-200{% endif %}"
                              id="status-{{ task.id }}">
                            <span class="status-icon mr-1.5">
                                {% if task.status == 'completed' %}‚úì
                                {% elif task.status == 'running' %}‚ü≥
                                {% elif task.status == 'failed' %}‚úó
                                {% else %}‚è≥{% endif %}
                            </span>
                            <span class="status-text">{{ task.status|upper }}</span>
                        </span>
                        
                        {% if task.status == 'running' %}
                        <div class="ml-2 flex space-x-1">
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- URL -->
                    <div class="mb-3">
                        <a href="{{ task.url }}" target="_blank" class="text-gray-900 font-medium hover:text-blue-600 transition flex items-center group">
                            <span class="truncate max-w-md">{{ task.url }}</span>
                            <svg class="w-4 h-4 ml-2 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </a>
                    </div>

                    <!-- Metadata -->
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="timestamp" data-timestamp="{{ task.timestamp }}">{{ task.timestamp }}</span>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                            </svg>
                            <span class="font-mono">{{ task.id[:8] }}</span>
                        </div>
                    </div>

                    <!-- Progress Bar (for running tasks) -->
                    {% if task.status == 'running' %}
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Error Message (for failed tasks) -->
                    {% if task.status == 'failed' %}
                    <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-xs text-red-700 flex items-start">
                            <svg class="w-4 h-4 mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            <span>Task failed. Click "View Details" to see error information.</span>
                        </p>
                    </div>
                    {% endif %}
                </div>

                <!-- Right: Actions -->
                <div class="flex-shrink-0 p-6 flex flex-col justify-center space-y-2 border-t md:border-t-0 md:border-l border-gray-200">
                    <a href="/task/{{ task.id }}" 
                       class="flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm hover:shadow-md text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        View Details
                    </a>
                    
                    {% if task.status == 'completed' %}
                    <button onclick="downloadTask('{{ task.id }}')" 
                            class="flex items-center justify-center px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download
                    </button>
                    {% endif %}
                    
                    {% if task.status == 'failed' %}
                    <button onclick="retryTask('{{ task.id }}')" 
                            class="flex items-center justify-center px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Retry
                    </button>
                    {% endif %}
                    
                    <button onclick="confirmDelete('{{ task.id }}', '{{ task.url }}')" 
                            class="flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-red-100 hover:text-red-700 transition text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="hidden text-center py-12 bg-white rounded-lg shadow">
        <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p class="text-gray-500 text-lg mb-2">No tasks found</p>
        <p class="text-gray-400 text-sm">Try adjusting your filters or search query</p>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16 bg-white rounded-xl shadow-lg">
        <div class="mb-6">
            <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">No tasks yet</h3>
        <p class="text-gray-600 mb-6 max-w-md mx-auto">
            Get started by creating your first screenshot or recording task. It only takes a few seconds!
        </p>
        <a href="/submit" class="inline-flex items-center bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg font-medium">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Create Your First Task
        </a>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all">
        <div class="p-6">
            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 text-center mb-2">Delete Task?</h3>
            <p class="text-gray-600 text-center mb-6">
                Are you sure you want to delete this task? This action cannot be undone.
            </p>
            <div class="bg-gray-50 rounded-lg p-3 mb-6">
                <p class="text-sm text-gray-700 break-all" id="deleteTaskUrl"></p>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeDeleteModal()" 
                        class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" 
                        class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                    Delete Task
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed top-4 right-4 max-w-md transform translate-x-full transition-transform duration-300 z-50">
    <div id="toastContent" class="bg-white rounded-lg shadow-2xl border-l-4 p-4">
        <div class="flex items-center space-x-3">
            <span id="toastIcon" class="text-2xl"></span>
            <div class="flex-1">
                <h4 id="toastTitle" class="font-semibold"></h4>
                <p id="toastMessage" class="text-sm text-gray-600"></p>
            </div>
            <button id="toastClose" class="text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toast Functions
    const toast = document.getElementById('toast');
    const toastContent = document.getElementById('toastContent');
    const toastIcon = document.getElementById('toastIcon');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    const toastClose = document.getElementById('toastClose');

    function showToast(type, title, message) {
        const colors = {
            success: { border: 'border-green-500', icon: '‚úì', bg: 'bg-green-50' },
            error: { border: 'border-red-500', icon: '‚úó', bg: 'bg-red-50' },
            info: { border: 'border-blue-500', icon: '‚Ñπ', bg: 'bg-blue-50' }
        };
        
        const style = colors[type] || colors.info;
        toastContent.className = `bg-white rounded-lg shadow-2xl border-l-4 ${style.border} p-4`;
        toastIcon.textContent = style.icon;
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        toast.classList.remove('translate-x-full');
        
        setTimeout(() => {
            toast.classList.add('translate-x-full');
        }, 5000);
    }
    
    toastClose.addEventListener('click', () => {
        toast.classList.add('translate-x-full');
    });

    // Delete Modal Functions
    let taskToDelete = null;

    function confirmDelete(taskId, taskUrl) {
        taskToDelete = taskId;
        document.getElementById('deleteTaskUrl').textContent = taskUrl;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
        taskToDelete = null;
        document.getElementById('deleteModal').classList.add('hidden');
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
        if (!taskToDelete) return;
        
        try {
            const response = await fetch(`/api/task/${taskToDelete}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('success', 'Task Deleted', 'The task has been successfully deleted');
                closeDeleteModal();
                
                // Remove task card from DOM
                const taskCard = document.querySelector(`[data-task-id="${taskToDelete}"]`);
                if (taskCard) {
                    taskCard.style.opacity = '0';
                    taskCard.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        taskCard.remove();
                        updateTaskCount();
                        checkEmptyState();
                    }, 300);
                }
            } else {
                showToast('error', 'Delete Failed', 'Failed to delete the task');
            }
        } catch (error) {
            showToast('error', 'Error', error.message);
        }
    });

    // Close modal on background click
    document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
            closeDeleteModal();
        }
    });

    // Download Function
    async function downloadTask(taskId) {
        showToast('info', 'Downloading', 'Preparing your download...');
        // Implement download logic here
        window.location.href = `/api/task/${taskId}/download`;
    }

    // Retry Function
    async function retryTask(taskId) {
        try {
            const response = await fetch(`/api/task/${taskId}/retry`, {
                method: 'POST'
            });

            if (response.ok) {
                showToast('success', 'Task Retrying', 'The task has been queued for retry');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast('error', 'Retry Failed', 'Failed to retry the task');
            }
        } catch (error) {
            showToast('error', 'Error', error.message);
        }
    }

    // Filter and Search Functions
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const sortOrder = document.getElementById('sortOrder');
    const taskCards = document.querySelectorAll('.task-card');
    const noResults = document.getElementById('noResults');
    const activeFilters = document.getElementById('activeFilters');
    const filterTags = document.getElementById('filterTags');
    const clearFiltersBtn = document.getElementById('clearFilters');

    function filterTasks() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedType = typeFilter.value;
        const selectedStatus = statusFilter.value;
        let visibleCount = 0;
        
        // Update active filters display
        updateActiveFilters();

        taskCards.forEach(card => {
            const url = card.dataset.url;
            const type = card.dataset.type;
            const status = card.dataset.status;
            
            const matchesSearch = url.includes(searchTerm);
            const matchesType = selectedType === 'all' || type === selectedType;
            const matchesStatus = selectedStatus === 'all' || status === selectedStatus;
            
            if (matchesSearch && matchesType && matchesStatus) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Update counts
        document.getElementById('visibleCount').textContent = visibleCount;
        
        // Show/hide no results message
        noResults.classList.toggle('hidden', visibleCount > 0);
        
        // Sort tasks
        sortTasks();
    }

    function sortTasks() {
        const tasksList = document.getElementById('tasksList');
        const cardsArray = Array.from(taskCards);
        const sortValue = sortOrder.value;
        
        cardsArray.sort((a, b) => {
            if (sortValue === 'newest') {
                return parseTimestamp(b.dataset.timestamp) - parseTimestamp(a.dataset.timestamp);
            } else if (sortValue === 'oldest') {
                return parseTimestamp(a.dataset.timestamp) - parseTimestamp(b.dataset.timestamp);
            } else if (sortValue === 'status') {
                const statusOrder = { failed: 0, running: 1, pending: 2, completed: 3 };
                return statusOrder[a.dataset.status] - statusOrder[b.dataset.status];
            }
        });
        
        cardsArray.forEach(card => tasksList.appendChild(card));
    }

    function updateActiveFilters() {
        const filters = [];
        
        if (searchInput.value) filters.push({ type: 'search', label: `"${searchInput.value}"` });
        if (typeFilter.value !== 'all') filters.push({ type: 'type', label: typeFilter.options[typeFilter.selectedIndex].text });
        if (statusFilter.value !== 'all') filters.push({ type: 'status', label: statusFilter.options[statusFilter.selectedIndex].text });
        
        if (filters.length > 0) {
            activeFilters.classList.remove('hidden');
            filterTags.innerHTML = filters.map(f => 
                `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    ${f.label}
                </span>`
            ).join('');
        } else {
            activeFilters.classList.add('hidden');
        }
    }

    function clearFilters() {
        searchInput.value = '';
        typeFilter.value = 'all';
        statusFilter.value = 'all';
        filterTasks();
    }

    searchInput.addEventListener('input', filterTasks);
    typeFilter.addEventListener('change', filterTasks);
    statusFilter.addEventListener('change', filterTasks);
    sortOrder.addEventListener('change', sortTasks);
    clearFiltersBtn.addEventListener('click', clearFilters);

    // Update task count
    function updateTaskCount() {
        const visible = document.querySelectorAll('.task-card:not([style*="display: none"])').length;
        document.getElementById('visibleCount').textContent = visible;
        document.getElementById('totalCount').textContent = taskCards.length;
    }

    function checkEmptyState() {
        const anyVisible = document.querySelectorAll('.task-card').length > 0;
        if (!anyVisible) {
            window.location.reload();
        }
    }

    // Absolute Local Time Display
    function updateAbsoluteTimes() {
        document.querySelectorAll('.timestamp').forEach(el => {
            const timestamp = el.dataset.timestamp;
            if (timestamp) {
                const date = parseTimestamp(timestamp);
                el.textContent = formatAbsoluteLocal(date);
                el.title = date.toLocaleString();
            }
        });
    }

    function formatAbsoluteLocal(date) {
        const months = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const day = date.getDate();
        const year = date.getFullYear();
        const monthName = months[date.getMonth()];

        function ordinal(n) {
            const rem10 = n % 10, rem100 = n % 100;
            if (rem100 >= 11 && rem100 <= 13) return `${n}th`;
            if (rem10 === 1) return `${n}st`;
            if (rem10 === 2) return `${n}nd`;
            if (rem10 === 3) return `${n}rd`;
            return `${n}th`;
        }

        let hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        if (hours === 0) hours = 12;
        const hh = String(hours).padStart(2, '0');
        const mm = String(minutes).padStart(2, '0');

        const offsetMinutes = date.getTimezoneOffset(); // minutes west of UTC
        const localMinutesFromUTC = -offsetMinutes; // minutes east of UTC
        const sign = localMinutesFromUTC >= 0 ? '+' : '-';
        const absMin = Math.abs(localMinutesFromUTC);
        const offHours = Math.floor(absMin / 60);
        const offMinutes = absMin % 60;
        const offsetStr = offMinutes === 0
            ? `${sign}${offHours}`
            : `${sign}${offHours}:${String(offMinutes).padStart(2, '0')}`;

        return `${monthName} ${ordinal(day)}, ${year} ${hh}:${mm} ${ampm} ${offsetStr} GMT`;
    }

    function parseTimestamp(ts) {
        if (!ts) return new Date();
        let normalized = ts.trim();
        const hasTZ = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(normalized);
        if (!hasTZ) normalized += 'Z';
        normalized = normalized.replace(' ', 'T');
        normalized = normalized.replace(/(\.\d{3})\d+$/, '$1');
        const d = new Date(normalized);
        if (isNaN(d.getTime())) return new Date(ts);
        return d;
    }

    // Format absolute times once on load
    updateAbsoluteTimes();

    // WebSocket Updates
    const autoRefresh = document.getElementById('autoRefresh');
    const tasks = Array.from(document.querySelectorAll('.task-card')).map(el => ({ id: el.dataset.taskId, status: el.dataset.status }));
    const wsConnections = {};

    function setupWebSocket(taskId) {
        if (!autoRefresh.checked) return;
        
        const wsUrl = (function() {
            const publicBase = "{{ backend_ws_public_url|default('', true) }}";
            if (publicBase) {
                const base = publicBase.replace(/\/$/, '');
                return `${base}/ws/tasks/${taskId}`;
            }
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            const host = location.hostname + ':8000';
            return `${proto}://${host}/ws/tasks/${taskId}`;
        })();
        const ws = new WebSocket(wsUrl);
        
        wsConnections[taskId] = ws;
        
        ws.onmessage = (evt) => {
            try {
                const data = JSON.parse(evt.data);
                if (data && data.task_id === taskId && data.status) {
                    updateTaskStatus(taskId, data.status);
                }
            } catch (e) {
                console.error('WebSocket message error:', e);
            }
        };
        
        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };
    }

    function updateTaskStatus(taskId, newStatus) {
        const badge = document.getElementById(`status-${taskId}`);
        if (!badge) return;
        
        const statusText = badge.querySelector('.status-text');
        const statusIcon = badge.querySelector('.status-icon');
        
        if (statusText.textContent.toUpperCase() === newStatus.toUpperCase()) return;
        
        // Update text
        statusText.textContent = newStatus.toUpperCase();
        
        // Update icon
        const icons = {
            completed: '‚úì',
            running: '‚ü≥',
            failed: '‚úó',
            pending: '‚è≥'
        };
        statusIcon.textContent = icons[newStatus] || '‚è≥';
        
        // Update colors
        const colors = {
            completed: 'bg-green-100 text-green-800 border-green-200',
            running: 'bg-blue-100 text-blue-800 border-blue-200',
            failed: 'bg-red-100 text-red-800 border-red-200',
            pending: 'bg-yellow-100 text-yellow-800 border-yellow-200'
        };
        
        badge.className = `status-badge px-3 py-1 text-xs font-semibold rounded-full inline-flex items-center ${colors[newStatus] || colors.pending}`;
        
        // Show toast for status changes
        if (newStatus === 'completed') {
            showToast('success', 'Task Completed', `Task ${taskId.substring(0, 8)} has finished successfully`);
        } else if (newStatus === 'failed') {
            showToast('error', 'Task Failed', `Task ${taskId.substring(0, 8)} has failed`);
        }
        
        // Update card dataset and strip running UI when done
        const card = document.querySelector(`[data-task-id="${taskId}"]`);
        if (card) {
            card.dataset.status = newStatus;

            if (newStatus !== 'running') {
                // Remove bouncing dots beside the badge
                const bouncingDots = badge.parentElement ? badge.parentElement.querySelectorAll('.animate-bounce') : [];
                bouncingDots.forEach(el => el.remove());

                // Remove the animated progress bar if present
                const pulses = card.querySelectorAll('.animate-pulse');
                pulses.forEach(el => {
                    const container = el.closest('.mt-3') || el.parentElement;
                    if (container) {
                        container.remove();
                    } else {
                        el.remove();
                    }
                });
            }
        }

        // Close websocket for terminal states
        if (newStatus === 'completed' || newStatus === 'failed') {
            const ws = wsConnections[taskId];
            if (ws) {
                try { ws.close(); } catch (e) {}
                delete wsConnections[taskId];
            }
        }
    }

    // Initialize WebSocket connections
    tasks.forEach(task => {
        if (task.status === 'running' || task.status === 'pending' || task.status === 'queued') {
            setupWebSocket(task.id);
        }
    });

    // Add file size display for completed tasks by checking media HEAD
    (function annotateCompletedSizes() {
        document.querySelectorAll('.task-card').forEach(card => {
            if (card.dataset.status === 'completed') {
                const taskId = card.dataset.taskId;
                const link = card.querySelector('a[href^="/task/"]');
                const type = card.dataset.type;
                // Fetch details to get result_file
                fetch(`/api/task/${taskId}`).then(r => r.json()).then(payload => {
                    const t = payload && payload.task ? payload.task : null;
                    if (!t || !t.result_file) return;
                    fetch(`/media/${t.result_file}`, { method: 'HEAD' }).then(r => {
                        const size = r.headers.get('Content-Length');
                        if (!size) return;
                        const bytes = parseInt(size, 10);
                        const human = bytes < 1024 ? `${bytes} B` : (bytes < 1024*1024 ? `${(bytes/1024).toFixed(1)} KB` : `${(bytes/1024/1024).toFixed(1)} MB`);
                        const meta = document.createElement('span');
                        meta.className = 'ml-2 text-xs text-gray-500';
                        meta.textContent = `¬∑ ${human}`;
                        const header = card.querySelector('.flex-1 .mb-3');
                        if (header) header.appendChild(meta);
                    }).catch(()=>{});
                }).catch(()=>{});
            }
        });
    })();

    // Handle auto-refresh toggle
    autoRefresh.addEventListener('change', (e) => {
        if (e.target.checked) {
            tasks.forEach(task => {
                if ((task.status === 'running' || task.status === 'pending' || task.status === 'queued') && !wsConnections[task.id]) {
                    setupWebSocket(task.id);
                }
            });
        } else {
            Object.values(wsConnections).forEach(ws => ws.close());
            Object.keys(wsConnections).forEach(key => delete wsConnections[key]);
        }
    });

    // Initial sort
    sortTasks();
</script>
{% endblock %}

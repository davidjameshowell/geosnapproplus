{% extends "base.html" %}

{% block title %}New Task{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-gray-900 mb-6">Create New Task</h1>

<form id="taskForm" class="bg-white rounded-lg shadow-lg p-6">
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Task Types *</label>
        <div class="flex space-x-4">
            <label class="flex items-center">
                <input type="checkbox" name="task_types" value="screenshot" class="mr-2">
                Screenshot
            </label>
            <label class="flex items-center">
                <input type="checkbox" name="task_types" value="recording" class="mr-2">
                Recording
            </label>
        </div>
    </div>

    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">URL *</label>
        <input type="url" name="url" required placeholder="https://example.com" 
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    </div>

    {% if flags.browser_type %}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Browser Type</label>
        <select name="browser_type" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="">Default (chromium)</option>
            <option value="chromium">Chromium</option>
            <option value="firefox">Firefox</option>
            <option value="webkit">WebKit</option>
        </select>
    </div>
    {% endif %}

    {% if flags.headless %}
    <div class="mb-4">
        <label class="flex items-center">
            <input type="checkbox" name="headless" value="true" checked class="mr-2">
            <span class="text-sm font-medium text-gray-700">Headless Mode</span>
        </label>
    </div>
    {% endif %}

    <div class="grid grid-cols-2 gap-4 mb-4">
        {% if flags.viewport_width %}
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Viewport Width</label>
            <input type="number" name="viewport_width" placeholder="1920" min="320" max="3840"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>
        {% endif %}
        
        {% if flags.viewport_height %}
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Viewport Height</label>
            <input type="number" name="viewport_height" placeholder="1080" min="240" max="2160"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>
        {% endif %}
    </div>

    {% if flags.wait_until %}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Wait Until</label>
        <select name="wait_until" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="">Default (networkidle)</option>
            <option value="load">Load</option>
            <option value="domcontentloaded">DOM Content Loaded</option>
            <option value="networkidle">Network Idle</option>
        </select>
    </div>
    {% endif %}

    {% if flags.wait_timeout %}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Wait Timeout (ms)</label>
        <input type="number" name="wait_timeout" placeholder="30000" min="1000" max="120000"
               class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>
    {% endif %}

    {% if flags.user_agent %}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">User Agent</label>
        <input type="text" name="user_agent" placeholder="Custom user agent (optional)"
               class="w-full px-3 py-2 border border-gray-300 rounded-md">
    </div>
    {% endif %}

    <div id="screenshotOptions" class="border-t pt-4 mt-4" style="display:none;">
        <h3 class="text-lg font-semibold mb-3">Screenshot Options</h3>
        
        {% if flags.full_page %}
        <div class="mb-4">
            <label class="flex items-center">
                <input type="checkbox" name="full_page" value="true" id="fullPageCheckbox" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Full Page Screenshot</span>
            </label>
        </div>
        {% endif %}

        {% if flags.image_type %}
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Image Type</label>
            <select name="image_type" id="imageType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="">Default (png)</option>
                <option value="png">PNG</option>
                <option value="jpeg">JPEG</option>
            </select>
        </div>
        {% endif %}

        {% if flags.quality %}
        <div class="mb-4" id="qualityField" style="display:none;">
            <label class="block text-sm font-medium text-gray-700 mb-1">Quality (JPEG only)</label>
            <input type="number" name="quality" placeholder="80" min="0" max="100"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>
        {% endif %}

        {% if flags.wait_for_selector %}
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Wait for Selector</label>
            <input type="text" name="wait_for_selector" placeholder=".main-content"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>
        {% endif %}

        {% if flags.clip_fields %}
        <div id="clipFields">
            <h4 class="text-sm font-semibold mb-2">Clip Region (all required)</h4>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-700 mb-1">Clip X</label>
                    <input type="number" name="clip_x" placeholder="0" min="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md clip-input">
                </div>
                <div>
                    <label class="block text-sm text-gray-700 mb-1">Clip Y</label>
                    <input type="number" name="clip_y" placeholder="0" min="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md clip-input">
                </div>
                <div>
                    <label class="block text-sm text-gray-700 mb-1">Clip Width</label>
                    <input type="number" name="clip_width" placeholder="800" min="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md clip-input">
                </div>
                <div>
                    <label class="block text-sm text-gray-700 mb-1">Clip Height</label>
                    <input type="number" name="clip_height" placeholder="600" min="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md clip-input">
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div id="recordingOptions" class="border-t pt-4 mt-4" style="display:none;">
        <h3 class="text-lg font-semibold mb-3">Recording Options</h3>
        
        {% if flags.record_duration %}
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Record Duration (seconds)</label>
            <input type="number" name="record_duration" placeholder="10" min="1" max="120"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>
        {% endif %}

        {% if flags.scroll_enabled %}
        <div class="mb-4">
            <label class="flex items-center">
                <input type="checkbox" name="scroll_enabled" value="true" id="scrollEnabled" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Enable Scrolling</span>
            </label>
        </div>
        {% endif %}

        {% if flags.scroll_speed %}
        <div class="mb-4" id="scrollSpeedField" style="display:none;">
            <label class="block text-sm font-medium text-gray-700 mb-1">Scroll Speed (px/step)</label>
            <input type="number" name="scroll_speed" placeholder="100" min="10" max="500"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>
        {% endif %}

        {% if flags.scroll_up_after %}
        <div class="mb-4" id="scrollUpField" style="display:none;">
            <label class="flex items-center">
                <input type="checkbox" name="scroll_up_after" value="true" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Scroll Back Up After</span>
            </label>
        </div>
        {% endif %}
    </div>

    <div class="mt-6">
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 transition">
            Submit Task
        </button>
    </div>

    <div id="errorMessage" class="mt-4 p-3 bg-red-100 text-red-700 rounded-md hidden"></div>
    <div id="successMessage" class="mt-4 p-3 bg-green-100 text-green-700 rounded-md hidden"></div>
</form>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('taskForm');
    const taskTypeCheckboxes = document.querySelectorAll('input[name="task_types"]');
    const screenshotOptions = document.getElementById('screenshotOptions');
    const recordingOptions = document.getElementById('recordingOptions');
    const imageType = document.getElementById('imageType');
    const qualityField = document.getElementById('qualityField');
    const fullPageCheckbox = document.getElementById('fullPageCheckbox');
    const clipInputs = document.querySelectorAll('.clip-input');
    const scrollEnabled = document.getElementById('scrollEnabled');
    const scrollSpeedField = document.getElementById('scrollSpeedField');
    const scrollUpField = document.getElementById('scrollUpField');

    // Toggle options visibility
    taskTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const screenshotChecked = document.querySelector('input[value="screenshot"]').checked;
            const recordingChecked = document.querySelector('input[value="recording"]').checked;
            
            screenshotOptions.style.display = screenshotChecked ? 'block' : 'none';
            recordingOptions.style.display = recordingChecked ? 'block' : 'none';
        });
    });

    // Show quality field only for JPEG
    if (imageType) {
        imageType.addEventListener('change', (e) => {
            qualityField.style.display = e.target.value === 'jpeg' ? 'block' : 'none';
        });
    }

    // Disable clip fields when full page is checked
    if (fullPageCheckbox) {
        fullPageCheckbox.addEventListener('change', (e) => {
            clipInputs.forEach(input => {
                input.disabled = e.target.checked;
                if (e.target.checked) input.value = '';
            });
        });
    }

    // Show scroll speed and scroll up fields when scroll is enabled
    if (scrollEnabled) {
        scrollEnabled.addEventListener('change', (e) => {
            scrollSpeedField.style.display = e.target.checked ? 'block' : 'none';
            scrollUpField.style.display = e.target.checked ? 'block' : 'none';
        });
    }

    // Form validation and submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const errorMsg = document.getElementById('errorMessage');
        const successMsg = document.getElementById('successMessage');
        errorMsg.classList.add('hidden');
        successMsg.classList.add('hidden');

        // Validate at least one task type is selected
        const selectedTypes = Array.from(taskTypeCheckboxes).filter(cb => cb.checked);
        if (selectedTypes.length === 0) {
            errorMsg.textContent = 'Please select at least one task type (Screenshot or Recording)';
            errorMsg.classList.remove('hidden');
            return;
        }

        // Build request payload
        const formData = new FormData(form);
        const payload = {
            task_types: selectedTypes.map(cb => cb.value)
        };

        for (let [key, value] of formData.entries()) {
            if (key === 'task_types') continue;
            
            if (value && value !== '') {
                // Convert checkboxes to booleans
                if (['headless', 'full_page', 'scroll_enabled', 'scroll_up_after'].includes(key)) {
                    payload[key] = value === 'true';
                }
                // Convert numbers
                else if (['viewport_width', 'viewport_height', 'wait_timeout', 'quality', 
                          'clip_x', 'clip_y', 'clip_width', 'clip_height', 
                          'record_duration', 'scroll_speed'].includes(key)) {
                    payload[key] = parseInt(value);
                }
                else {
                    payload[key] = value;
                }
            }
        }

        // Validation: clip fields
        const clipFields = ['clip_x', 'clip_y', 'clip_width', 'clip_height'];
        const clipProvided = clipFields.filter(f => payload[f] !== undefined);
        if (clipProvided.length > 0 && clipProvided.length < 4) {
            errorMsg.textContent = 'All clip fields (x, y, width, height) must be provided together';
            errorMsg.classList.remove('hidden');
            return;
        }

        // Validation: full_page and clip cannot be combined
        if (payload.full_page && clipProvided.length > 0) {
            errorMsg.textContent = 'Cannot use clip fields with full_page screenshot';
            errorMsg.classList.remove('hidden');
            return;
        }

        // Validation: quality only for JPEG
        if (payload.quality && payload.image_type !== 'jpeg') {
            errorMsg.textContent = 'Quality can only be set for JPEG images';
            errorMsg.classList.remove('hidden');
            return;
        }

        try {
            const response = await fetch('/api/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (response.ok) {
                successMsg.textContent = 'Task(s) submitted successfully!';
                successMsg.classList.remove('hidden');
                
                // Redirect to tasks page after 1.5 seconds
                setTimeout(() => {
                    window.location.href = '/tasks';
                }, 1500);
            } else {
                errorMsg.textContent = JSON.stringify(result);
                errorMsg.classList.remove('hidden');
            }
        } catch (error) {
            errorMsg.textContent = 'Error: ' + error.message;
            errorMsg.classList.remove('hidden');
        }
    });
</script>
{% endblock %}
